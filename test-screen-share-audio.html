<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å±å¹•åˆ†äº«éŸ³é¢‘åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .feature-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .feature-list li:before {
            content: "âœ… ";
            color: #4caf50;
            font-weight: bold;
        }
        .test-section {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .audio-status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        .audio-status.active {
            display: block;
        }
        .video-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 120px;
        }
        .btn-primary {
            background: #4a9eff;
            color: white;
        }
        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        .btn-danger:hover {
            background: #ff3742;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }
        .log-entry.success {
            color: #4caf50;
        }
        .log-entry.error {
            color: #ff4757;
        }
        .log-entry.warning {
            color: #ffa726;
        }
        .log-entry.info {
            color: #42a5f5;
        }
        .browser-support {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .improvement-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="feature-highlight">
            <h1>ğŸ¯ å±å¹•åˆ†äº«éŸ³é¢‘åŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•æ–°å¢çš„ç³»ç»ŸéŸ³é¢‘æ•è·åŠŸèƒ½ - ç°åœ¨å­¦ç”Ÿä»¬å¯ä»¥å¬åˆ°çºªå½•ç‰‡çš„å£°éŸ³äº†ï¼</p>
        </div>

        <div class="improvement-box">
            <h3>ğŸš€ åŠŸèƒ½æ”¹è¿›è¯´æ˜</h3>
            <ul class="feature-list">
                <li>ä½¿ç”¨ getDisplayMedia API ç›´æ¥è·å–å±å¹•åˆ†äº«æµ</li>
                <li>æ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·ï¼ˆChrome 74+ï¼‰</li>
                <li>åˆ†åˆ«å‘å¸ƒè§†é¢‘å’ŒéŸ³é¢‘è½¨é“åˆ° LiveKit</li>
                <li>éŸ³é¢‘ä½¿ç”¨ music é¢„è®¾ï¼Œæä¾›æ›´å¥½çš„éŸ³è´¨</li>
                <li>æ™ºèƒ½æ£€æµ‹éŸ³é¢‘è½¨é“æ˜¯å¦æˆåŠŸè·å–</li>
                <li>æä¾›è¯¦ç»†çš„ç”¨æˆ·åé¦ˆå’Œé”™è¯¯å¤„ç†</li>
            </ul>
        </div>

        <div class="browser-support">
            <h4>ğŸŒ æµè§ˆå™¨æ”¯æŒæƒ…å†µ</h4>
            <p>
                <strong>âœ… å®Œå…¨æ”¯æŒç³»ç»ŸéŸ³é¢‘ï¼š</strong> Chrome 74+, Edge 79+<br>
                <strong>âš ï¸ éƒ¨åˆ†æ”¯æŒï¼š</strong> Firefoxï¼ˆéœ€æ‰‹åŠ¨é€‰æ‹©éŸ³é¢‘æºï¼‰<br>
                <strong>âŒ ä¸æ”¯æŒï¼š</strong> Safariï¼ˆä»…æ”¯æŒè§†é¢‘åˆ†äº«ï¼‰
            </p>
        </div>

        <div class="test-section">
            <h3>ğŸ® åŠŸèƒ½æµ‹è¯•</h3>
            
            <div id="audioStatus" class="audio-status">
                <div id="audioStatusText">ğŸ”Š ç³»ç»ŸéŸ³é¢‘å·²æˆåŠŸæ•è·ï¼å­¦ç”Ÿä»¬ç°åœ¨å¯ä»¥å¬åˆ°çºªå½•ç‰‡çš„å£°éŸ³</div>
            </div>

            <div class="video-preview" id="videoPreview">
                ğŸ“º å±å¹•åˆ†äº«é¢„è§ˆåŒºåŸŸ
            </div>

            <div class="controls">
                <button id="startBtn" class="btn btn-primary" onclick="startScreenShare()">
                    ğŸš€ å¼€å§‹å±å¹•åˆ†äº«ï¼ˆå«éŸ³é¢‘ï¼‰
                </button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopScreenShare()" disabled>
                    â¹ï¸ åœæ­¢å±å¹•åˆ†äº«
                </button>
                <button id="testAudioBtn" class="btn btn-success" onclick="testAudioDetection()">
                    ğŸ” æµ‹è¯•éŸ³é¢‘æ£€æµ‹
                </button>
                <button id="clearLogBtn" class="btn" onclick="clearLog()" style="background: #6c757d; color: white;">
                    ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
        </div>

        <div class="log-area" id="logArea">
            <div class="log-entry info">ğŸ¯ å±å¹•åˆ†äº«éŸ³é¢‘åŠŸèƒ½æµ‹è¯•å·²å¯åŠ¨...</div>
            <div class="log-entry info">ğŸ’¡ ç‚¹å‡»"å¼€å§‹å±å¹•åˆ†äº«"æŒ‰é’®æµ‹è¯•æ–°åŠŸèƒ½</div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let videoTrack = null;
        let audioTrack = null;

        function log(type, message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function startScreenShare() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const videoPreview = document.getElementById('videoPreview');
            const audioStatus = document.getElementById('audioStatus');

            try {
                startBtn.disabled = true;
                log('info', 'ğŸš€ å¼€å§‹è·å–å±å¹•åˆ†äº«æµ...');

                // ğŸ¯ æ–°çš„å±å¹•åˆ†äº«é…ç½® - åŒ…å«éŸ³é¢‘
                const displayMediaOptions = {
                    video: {
                        mediaSource: 'screen',
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    },
                    // Chrome ç‰¹æœ‰çš„ç³»ç»ŸéŸ³é¢‘é€‰é¡¹
                    systemAudio: 'include',
                    selfBrowserSurface: 'exclude',
                    surfaceSwitching: 'include'
                };

                log('info', 'ğŸ“‹ è¯·æ±‚å±å¹•åˆ†äº«æƒé™...');
                log('info', 'ğŸ’¡ è¯·åœ¨å¼¹å‡ºçª—å£ä¸­é€‰æ‹©"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹');

                currentStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                
                // è·å–è½¨é“
                videoTrack = currentStream.getVideoTracks()[0];
                audioTrack = currentStream.getAudioTracks()[0];

                // æ˜¾ç¤ºç»“æœ
                log('success', `ğŸ“º è§†é¢‘è½¨é“: ${videoTrack ? 'âœ… å·²è·å–' : 'âŒ æœªè·å–'}`);
                log('success', `ğŸ”Š éŸ³é¢‘è½¨é“: ${audioTrack ? 'âœ… å·²è·å– (åŒ…å«ç³»ç»ŸéŸ³é¢‘!)' : 'âŒ æœªè·å–'}`);

                if (audioTrack) {
                    log('success', 'ğŸ‰ æˆåŠŸï¼å­¦ç”Ÿä»¬ç°åœ¨å¯ä»¥å¬åˆ°çºªå½•ç‰‡çš„å£°éŸ³äº†');
                    audioStatus.classList.add('active');
                    
                    // æ˜¾ç¤ºéŸ³é¢‘è½¨é“è¯¦ç»†ä¿¡æ¯
                    const audioSettings = audioTrack.getSettings();
                    log('info', `ğŸµ éŸ³é¢‘è®¾ç½®: é‡‡æ ·ç‡=${audioSettings.sampleRate}Hz, å£°é“=${audioSettings.channelCount}`);
                } else {
                    log('warning', 'âš ï¸ æœªè·å–åˆ°ç³»ç»ŸéŸ³é¢‘ï¼Œå¯èƒ½çš„åŸå› ï¼š');
                    log('warning', '  â€¢ æµè§ˆå™¨ä¸æ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·');
                    log('warning', '  â€¢ ç”¨æˆ·æœªé€‰æ‹©"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹');
                    log('warning', '  â€¢ é€‰æ‹©çš„å†…å®¹æºä¸æ”¯æŒéŸ³é¢‘');
                }

                // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
                if (videoTrack) {
                    const video = document.createElement('video');
                    video.srcObject = new MediaStream([videoTrack]);
                    video.autoplay = true;
                    video.muted = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    
                    videoPreview.innerHTML = '';
                    videoPreview.appendChild(video);
                }

                // ç›‘å¬æµç»“æŸäº‹ä»¶
                videoTrack?.addEventListener('ended', () => {
                    log('info', 'ğŸ“º ç”¨æˆ·åœæ­¢äº†å±å¹•åˆ†äº«');
                    stopScreenShare();
                });

                audioTrack?.addEventListener('ended', () => {
                    log('info', 'ğŸ”Š éŸ³é¢‘æµå·²ç»“æŸ');
                });

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                stopBtn.disabled = false;
                log('success', 'âœ… å±å¹•åˆ†äº«å·²å¯åŠ¨ï¼');

                // æ¨¡æ‹Ÿ LiveKit å‘å¸ƒ
                simulateLiveKitPublish();

            } catch (error) {
                log('error', `âŒ å±å¹•åˆ†äº«å¤±è´¥: ${error.message}`);
                
                if (error.message.includes('Permission denied')) {
                    log('warning', 'ğŸ’¡ è§£å†³æ–¹æ¡ˆ: è¯·ç‚¹å‡»"å…è®¸"å¹¶é€‰æ‹©è¦åˆ†äº«çš„å±å¹•');
                    log('warning', 'ğŸ”Š é‡è¦: å‹¾é€‰"åˆ†äº«ç³»ç»ŸéŸ³é¢‘"é€‰é¡¹ä»¥å…±äº«å£°éŸ³');
                } else if (error.message.includes('NotSupported')) {
                    log('error', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒå±å¹•åˆ†äº«ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge');
                }
                
                startBtn.disabled = false;
            }
        }

        function stopScreenShare() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const videoPreview = document.getElementById('videoPreview');
            const audioStatus = document.getElementById('audioStatus');

            if (currentStream) {
                // åœæ­¢æ‰€æœ‰è½¨é“
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    log('info', `ğŸ›‘ åœæ­¢è½¨é“: ${track.kind} (${track.label})`);
                });
                
                currentStream = null;
                videoTrack = null;
                audioTrack = null;
            }

            // é‡ç½®UI
            videoPreview.innerHTML = 'ğŸ“º å±å¹•åˆ†äº«é¢„è§ˆåŒºåŸŸ';
            audioStatus.classList.remove('active');
            startBtn.disabled = false;
            stopBtn.disabled = true;

            log('success', 'âœ… å±å¹•åˆ†äº«å·²åœæ­¢');
        }

        function simulateLiveKitPublish() {
            log('info', 'ğŸ¯ æ¨¡æ‹Ÿ LiveKit å‘å¸ƒè¿‡ç¨‹...');
            
            if (videoTrack) {
                log('info', 'ğŸ“º å‘å¸ƒè§†é¢‘è½¨é“åˆ° LiveKit (source: ScreenShare)');
                log('info', '  â€¢ ç¼–è§£ç å™¨: VP8');
                log('info', '  â€¢ åˆ†è¾¨ç‡: ' + videoTrack.getSettings().width + 'x' + videoTrack.getSettings().height);
            }

            if (audioTrack) {
                log('info', 'ğŸ”Š å‘å¸ƒéŸ³é¢‘è½¨é“åˆ° LiveKit (source: ScreenShareAudio)');
                log('info', '  â€¢ é¢„è®¾: AudioPresets.music (é«˜éŸ³è´¨)');
                log('info', '  â€¢ é‡‡æ ·ç‡: ' + audioTrack.getSettings().sampleRate + 'Hz');
                log('success', 'ğŸ‰ ç³»ç»ŸéŸ³é¢‘å·²æˆåŠŸå‘å¸ƒï¼å­¦ç”Ÿä»¬å¯ä»¥å¬åˆ°å£°éŸ³äº†');
            }
        }

        function testAudioDetection() {
            log('info', 'ğŸ” æµ‹è¯•éŸ³é¢‘æ£€æµ‹åŠŸèƒ½...');
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                log('error', 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ getDisplayMedia API');
                return;
            }

            // æ£€æŸ¥ Chrome ç‰¹æœ‰åŠŸèƒ½
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            if (isChrome) {
                log('success', 'âœ… Chrome æµè§ˆå™¨ - æ”¯æŒç³»ç»ŸéŸ³é¢‘æ•è·');
            } else {
                log('warning', 'âš ï¸ é Chrome æµè§ˆå™¨ - ç³»ç»ŸéŸ³é¢‘æ”¯æŒå¯èƒ½æœ‰é™');
            }

            // æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
            if (window.isSecureContext) {
                log('success', 'âœ… å®‰å…¨ä¸Šä¸‹æ–‡ (HTTPS/localhost) - å¯ä»¥ä½¿ç”¨å±å¹•åˆ†äº«');
            } else {
                log('error', 'âŒ éå®‰å…¨ä¸Šä¸‹æ–‡ - å±å¹•åˆ†äº«å¯èƒ½è¢«ç¦ç”¨');
            }

            log('info', 'ğŸŒ æµè§ˆå™¨ä¿¡æ¯: ' + navigator.userAgent.split(' ').slice(-2).join(' '));
        }

        function clearLog() {
            const logArea = document.getElementById('logArea');
            logArea.innerHTML = '<div class="log-entry info">ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.addEventListener('load', () => {
            log('success', 'ğŸ¯ å±å¹•åˆ†äº«éŸ³é¢‘åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            testAudioDetection();
        });
    </script>
</body>
</html> 